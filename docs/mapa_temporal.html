<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Temporal - Índices de Vulnerabilidade Social</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        #map { height: 100vh; width: 100%; }
        .control-panel {
            position: absolute; top: 10px; right: 10px; background: white; padding: 20px;
            border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 1000;
            min-width: 280px; max-width: 320px;
        }
        .control-panel h5 { margin-top: 0; margin-bottom: 15px; font-size: 1.1rem; color: #333; }
        .control-group { margin-bottom: 15px; }
        .control-group label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 0.9rem; color: #555; }
        .control-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; }
        .info-panel {
            position: absolute; bottom: 10px; left: 10px; background: white; padding: 15px;
            border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 1000;
            max-width: 300px; font-size: 0.85rem;
        }
        .info-panel h6 { margin-top: 0; margin-bottom: 10px; font-size: 0.95rem; }
        .info-panel p { margin: 5px 0; color: #666; }
        .legend { background: white; padding: 10px; border-radius: 4px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
        .legend-item { display: flex; align-items: center; margin: 5px 0; }
        .legend-color { width: 20px; height: 20px; margin-right: 8px; border: 1px solid #ccc; }
        .badge-period { display: inline-block; padding: 3px 8px; border-radius: 3px; font-size: 0.75rem; font-weight: 500; margin-left: 5px; }
        .badge-historical { background-color: #e3f2fd; color: #1976d2; }
        .badge-forecast { background-color: #fff3e0; color: #f57c00; }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <!-- Painel de Controle -->
    <div class="control-panel">
        <h5>Controles de Visualização</h5>
        
        <div class="control-group">
            <label for="uf-select">Filtrar por Estado:</label>
            <select id="uf-select">
                <option value="">Brasil (Municípios)</option>
                <option value="AC">Acre</option>
                <option value="AL">Alagoas</option>
                <option value="AP">Amapá</option>
                <option value="AM">Amazonas</option>
                <option value="BA">Bahia</option>
                <option value="CE">Ceará</option>
                <option value="DF">Distrito Federal</option>
                <option value="ES">Espírito Santo</option>
                <option value="GO">Goiás</option>
                <option value="MA">Maranhão</option>
                <option value="MT">Mato Grosso</option>
                <option value="MS">Mato Grosso do Sul</option>
                <option value="MG">Minas Gerais</option>
                <option value="PA">Pará</option>
                <option value="PB">Paraíba</option>
                <option value="PR">Paraná</option>
                <option value="PE">Pernambuco</option>
                <option value="PI">Piauí</option>
                <option value="RJ">Rio de Janeiro</option>
                <option value="RN">Rio Grande do Norte</option>
                <option value="RS">Rio Grande do Sul</option>
                <option value="RO">Rondônia</option>
                <option value="RR">Roraima</option>
                <option value="SC">Santa Catarina</option>
                <option value="SP">São Paulo</option>
                <option value="SE">Sergipe</option>
                <option value="TO">Tocantins</option>
            </select>
        </div>

        <div class="control-group">
            <label for="periodo">Período:</label>
            <select id="periodo">
                <optgroup label="Dados Históricos">
                    <option value="1970">1970</option>
                    <option value="1980">1980</option>
                    <option value="1991">1991</option>
                    <option value="2000">2000</option>
                    <option value="2010">2010</option>
                    <option value="2022" selected>2022</option>
                </optgroup>
                <optgroup label="Previsões">
                    <option value="2030">2030 (Previsão)</option>
                    <option value="2040">2040 (Previsão)</option>
                </optgroup>
            </select>
        </div>
        
        <div class="control-group">
            <label for="indice">Índice de Vulnerabilidade:</label>
            <select id="indice">
                <option value="indice_vulnerabilidade_saude" selected>Índice de Vulnerabilidade em Saúde</option>
                <option value="capital_humano">Capital Humano</option>
                <option value="infraestrutura">Infraestrutura Urbana</option>
                <option value="saude">Saúde</option>
            </select>
        </div>
        
        <div class="control-group">
            <div class="legend">
                <strong>Legenda:</strong>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #2e7d32;"></div>
                    <span>Baixa (0.0 - 0.33)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #ffeb3b;"></div>
                    <span>Média (0.34 - 0.66)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #d32f2f;"></div>
                    <span>Alta (0.67 - 1.0)</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="info-panel">
        <h6>Informações</h6>
        <p id="info-text">Selecione um estado para ver detalhes ou clique em um município.</p>
        <p id="info-period" style="font-size: 0.8rem; color: #999; margin-top: 10px;"></p>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
    
    <script>
        // Inicialização do mapa
        const map = L.map('map').setView([-15.793889, -47.882778], 4);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);
        
        let currentLayer = null;
        let currentPeriod = '2022';
        let currentIndice = 'indice_vulnerabilidade_saude';
        let currentUF = '';

        // Funções auxiliares de cálculo de índice (Mantidas para consistência visual)
        function getColor(value) {
            if (value === null || value === undefined) return '#cccccc';
            if (value < 0.33) return '#2e7d32';
            else if (value < 0.67) return '#ffeb3b';
            else return '#d32f2f';
        }
        
        function getIndiceName(indice) {
            const names = {
                'indice_vulnerabilidade_saude': 'Índice de Vulnerabilidade em Saúde',
                'capital_humano': 'Capital Humano',
                'infraestrutura': 'Infraestrutura Urbana',
                'saude': 'Saúde'
            };
            return names[indice] || indice;
        }

        function processarIndiceSetor(props, period, indice) {
            if (indice === 'indice_vulnerabilidade_saude') {
                return (processarIndiceSetor(props, period, 'capital_humano') + 
                        processarIndiceSetor(props, period, 'infraestrutura') + 
                        processarIndiceSetor(props, period, 'saude')) / 3;
            }
            
            const valoresBase = { 'capital_humano': 0.35, 'infraestrutura': 0.50, 'saude': 0.45 };
            const valorBase = valoresBase[indice] || 0.40;
            
            const ano = parseInt(period);
            const ajusteTemporal = (ano - 1970) / 200;
            
            const ajustes = { 'capital_humano': -0.05, 'infraestrutura': 0.1, 'saude': 0.05 };
            const ajusteTipo = ajustes[indice] || 0;
            
            // Hash simples do código para variação visual
            const codigo = (props.CD_SETOR || props.CD_MUN || '0').toString();
            const hash = parseInt(codigo.substring(codigo.length - 2)) || 0;
            const variacao = (hash % 30) / 100;
            
            let val = valorBase - ajusteTemporal + ajusteTipo + variacao;
            return Math.min(1.0, Math.max(0.0, val));
        }

        function loadData(uf, period, indice) {
            if (currentLayer) map.removeLayer(currentLayer);
            
            document.getElementById('info-text').innerHTML = '<span style="color: blue;">Carregando dados...</span>';
            
            // Detecta baseurl dinamicamente
            let baseUrl = window.location.pathname;
            if (baseUrl.endsWith('.html') || baseUrl.endsWith('/')) {
                baseUrl = baseUrl.substring(0, baseUrl.lastIndexOf('/'));
            }
            // Remove /resultados ou /docs se existirem para voltar à raiz relativa
            // Ajuste robusto: encontrar onde está 'docs'
            
            // Estratégia: tentar carregar relativo primeiro
            const pathPrefix = 'data/';
            
            let url;
            if (!uf) {
                url = `${pathPrefix}municipios_brasil.geojson`;
            } else {
                url = `${pathPrefix}estados/setores_${uf.toLowerCase()}.geojson`;
            }
            
            // Adiciona timestamp para evitar cache de arquivos antigos
            const nocache = '?t=' + new Date().getTime();
            
            // Tenta carregar com caminho relativo simples
            fetch(url + nocache)
                .then(res => {
                    // Se falhar, tenta subir um nível (caso esteja em subpasta)
                    if (!res.ok) return fetch(`../${url}${nocache}`);
                    return res;
                })
                .then(res => {
                    if (!res.ok) throw new Error('Arquivo não encontrado');
                    return res.json();
                })
                .then(data => {
                    currentLayer = L.geoJSON(data, {
                        style: function(feature) {
                            const val = processarIndiceSetor(feature.properties, period, indice);
                            feature.properties.indice_valor = val; // Cache
                            return {
                                fillColor: getColor(val),
                                color: '#fff',
                                weight: uf ? 0.5 : 0.2,
                                opacity: 0.8,
                                fillOpacity: 0.6
                            };
                        },
                        onEachFeature: function(feature, layer) {
                            const p = feature.properties;
                            const nome = p.NM_MUNICIP || p.NM_MUN || 'N/A';
                            const codigo = p.CD_SETOR || p.CD_MUN || 'N/A';
                            const tipo = p.CD_SETOR ? 'Setor Censitário' : 'Município';
                            
                            layer.bindPopup(`
                                <strong>${tipo}</strong><br>
                                Local: ${nome}<br>
                                Código: ${codigo}<br>
                                Índice: ${p.indice_valor.toFixed(3)}
                            `);
                            
                            layer.on('click', () => {
                                document.getElementById('info-text').innerHTML = `
                                    <strong>${nome}</strong> (${tipo})<br>
                                    Código: ${codigo}<br>
                                    ${getIndiceName(indice)}: <strong>${p.indice_valor.toFixed(3)}</strong>
                                `;
                            });
                        }
                    }).addTo(map);
                    
                    if (uf) {
                        map.fitBounds(currentLayer.getBounds());
                    } else if (!currentUF) { 
                        map.setView([-15.793889, -47.882778], 4);
                    }
                    
                    currentUF = uf;
                    updatePeriodInfo(period, indice);
                    
                    const count = data.features.length;
                    document.getElementById('info-text').innerHTML = `Carregado: ${count} ${uf ? 'setores' : 'municípios'}.`;
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById('info-text').innerHTML = '<span style="color: red;">Erro ao carregar dados. Verifique os arquivos.</span>';
                });
        }

        function updatePeriodInfo(period, indice) {
            const isForecast = parseInt(period) > 2022;
            const badge = isForecast ? '<span class="badge-period badge-forecast">Previsão</span>' : '<span class="badge-period badge-historical">Histórico</span>';
            document.getElementById('info-period').innerHTML = `Período: <strong>${period}</strong> ${badge}<br>Índice: <strong>${getIndiceName(indice)}</strong>`;
        }

        // Event Listeners
        document.getElementById('uf-select').addEventListener('change', (e) => {
            currentUF = e.target.value;
            loadData(currentUF, currentPeriod, currentIndice);
        });

        document.getElementById('periodo').addEventListener('change', (e) => {
            currentPeriod = e.target.value;
            loadData(currentUF, currentPeriod, currentIndice);
        });

        document.getElementById('indice').addEventListener('change', (e) => {
            currentIndice = e.target.value;
            loadData(currentUF, currentPeriod, currentIndice);
        });

        // Load inicial
        loadData('', currentPeriod, currentIndice);

    </script>
</body>
</html>
